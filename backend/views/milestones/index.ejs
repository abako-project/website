<link rel='stylesheet' type='text/css' href='/stylesheets/forms.css'/>


<h1>Milestones</h1>


<% if (locals.loginUser && locals.loginUser.developerId === project.consultantId) { %>
    <p>
        <a href="" id="addmilestone">Crear nuevo Milestone</a>
    </p>
    <script>
      document.getElementById("addmilestone").href = '/projects/<%= project.id %>/milestones/new?clienttimezoneoffset=' + new Date().getTimezoneOffset();
    </script>
<% } %>

<% for (const i in project.milestones) { %>

    <% const milestone = project.milestones[i]; %>

    <div class="card">

        <%- include("./_show", {milestone}) %>

        <br/>

        <% if (locals.loginUser && locals.loginUser.developerId === project.consultantId) { %>

            <button class="milestoneEdit"
                    data-milestone-id="<%= milestone.id %>"
                    data-project-id="<%= project.id %>">Edit
            </button>
            <button class="milestoneDelete"
                    data-milestone-id="<%= milestone.id %>"
                    data-project-id="<%= project.id %>">Delete
            </button>

            <% if (+i > 0) { %>
                <button class="milestoneSwapOrder"
                        data-milestone-id="<%= milestone.id %>"
                        data-other-milestone-id="<%= project.milestones[+i-1].id %>"
                        data-project-id="<%= project.id %>">▲
                </button>
            <% } %>

            <% if (+i < project.milestones.length - 1) { %>
                <button class="milestoneSwapOrder"
                        data-milestone-id="<%= milestone.id %>"
                        data-other-milestone-id="<%= project.milestones[+i+1].id %>"
                        data-project-id="<%= project.id %>">▼
                </button>
            <% } %>
        <% } %>

    </div>
<% } %>

<script type="module">
  document.addEventListener("click", async ev => {

    const projectId = ev.target.dataset.projectId;
    const milestoneId = ev.target.dataset.milestoneId;

    if (ev.target.matches(".milestoneEdit")) {
      ev.preventDefault();
      location.href = "/projects/" + projectId + "/milestones/" + milestoneId + "/edit?clienttimezoneoffset=" + new Date().getTimezoneOffset();
    } else if (ev.target.matches(".milestoneDelete")) {
      ev.preventDefault();
      location.href = "/projects/" + projectId + "/milestones/" + milestoneId + "?_method=DELETE";
    } else if (ev.target.matches(".milestoneSwapOrder")) {
      ev.preventDefault();
      const otherMilestoneId = ev.target.dataset.otherMilestoneId;
      location.href = "/projects/" + projectId + "/milestones/swaporder/" + milestoneId + "/" + otherMilestoneId + "?_method=PUT";
    }
  })
</script>


<button id="projectNextButton" data-project-id="<%= project.id %>">Next</button>
<script type="module">
  document.getElementById('projectNextButton').addEventListener('click', async ev => {

      <% if (locals.loginUser.developerId === project.consultantId &&
              project.state &&
              ["scopingInProgress"].includes(project.state)) { %>

    ev.preventDefault();
    const projectId = ev.target.dataset.projectId;
    location.href = "/projects/" + projectId + "?clienttimezoneoffset=" + new Date().getTimezoneOffset();

      <% } %>

  });
</script>


